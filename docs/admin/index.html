<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Admin - Marido de Aluguel</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    :root {
      --bg-gradient-start: #8e44ad; --bg-gradient-end: #614bc3; --bg-header: rgba(118, 75, 162, 0.8);
      --card-bg: #ffffff; --text-dark: #34495e; --text-muted: #7f8c8d; --text-on-header: #ffffff;
      --green: #2ecc71; --blue: #3498db; --orange: #f39c12; --red: #e74c3c;
      --nav-btn-bg: rgba(255, 255, 255, 0.1); --nav-btn-hover: rgba(255, 255, 255, 0.2); --nav-btn-active: #ffffff; --border-color: #ecf0f1;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Poppins',sans-serif;background:linear-gradient(135deg,var(--bg-gradient-start),var(--bg-gradient-end));color:var(--text-dark);-webkit-font-smoothing:antialiased}
    .admin-panel{display:flex;flex-direction:column;height:100vh}
    .main-header{background-color:var(--bg-header);backdrop-filter:blur(5px);padding:20px 40px;display:flex;justify-content:space-between;align-items:center}
    .header-title{display:flex;align-items:center;gap:16px}
    .header-title .logo{width:40px;height:40px;background:#fff;border-radius:8px;display:grid;place-items:center;font-size:1.5rem;color:#8e44ad}
    .header-title .title-text h1{font-size:1.5rem;font-weight:600;color:var(--text-on-header)}
    .header-title .title-text p{font-size:.9rem;color:var(--text-on-header);opacity:.8}
    .status-badge{background-color:var(--green);color:#fff;padding:8px 16px;border-radius:20px;font-size:.9rem;font-weight:500}
    .main-nav{background:rgba(0,0,0,.1);padding:10px 40px}
    .main-nav ul{list-style:none;display:flex;gap:10px}
    .main-nav a{display:flex;align-items:center;gap:8px;text-decoration:none;color:var(--text-on-header);background-color:var(--nav-btn-bg);padding:10px 20px;border-radius:8px;font-weight:500;transition:all .2s ease}
    .main-nav a:hover{background-color:var(--nav-btn-hover)}
    .main-nav a.active{background-color:var(--nav-btn-active);color:var(--text-dark)}
    .content-area{flex-grow:1;padding:40px;overflow-y:auto}
    .page{display:none}.page.active{display:block}
    .card{background:var(--card-bg);border-radius:12px;padding:24px;box-shadow:0 4px 15px rgba(0,0,0,.1)}
    .overview-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:24px}
    .stat-card{position:relative}.stat-card .title{font-size:1.1rem;font-weight:500;color:var(--text-muted)}.stat-card .value{font-size:3rem;font-weight:700;margin-top:8px}.stat-card .detail{font-size:.9rem;color:var(--green);font-weight:500}
    .stat-card .icon{position:absolute;top:24px;right:24px;font-size:2.5rem;color:#ecf0f1}
    .form-section .title{font-size:1.2rem;font-weight:600;margin-bottom:8px}.form-section .subtitle{color:var(--text-muted);margin-bottom:24px}
    .form-group{margin-bottom:20px}.form-group label{display:block;font-weight:500;margin-bottom:8px}
    .form-group select,.form-group textarea{width:100%;padding:12px;border:1px solid #bdc3c7;border-radius:8px;font-size:1rem;font-family:'Poppins',sans-serif}
    .form-group textarea{min-height:120px;resize:vertical}
    .btn-purple{background:var(--bg-gradient-start);color:#fff;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-size:1rem;font-weight:600}
    .user-stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:24px}
    .stat-list .item{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border-color)}
    .stat-list .item:last-child{border-bottom:none}
    .stat-list .stat-value{font-weight:700;color:#fff;background:var(--bg-gradient-start);border-radius:12px;padding:2px 10px;font-size:.9rem}
    .manage-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
    .search-filter input{width:100%;padding:12px 16px;border:1px solid #bdc3c7;border-radius:8px}
    .user-list{display:flex;flex-direction:column;gap:12px;max-height:400px;overflow-y:auto}
    .user-item{display:flex;align-items:center;gap:16px;padding:12px;border:1px solid var(--border-color);border-radius:8px}
    .user-tag{font-size:.75rem;font-weight:600;padding:4px 10px;border-radius:12px;color:#fff}
    .tag-cliente{background-color:var(--blue)}.tag-prestador{background-color:var(--green)}.tag-admin{background-color:#8e44ad}
    .user-info{flex-grow:1}.user-info .name{font-weight:600}.user-info .contact{font-size:.85rem;color:var(--text-muted)}
    .user-actions .btn{border:none;padding:8px 12px;border-radius:6px;cursor:pointer;color:#fff}
    .log-item{display:flex;gap:16px;padding:16px;border:1px solid var(--border-color);border-radius:8px;margin-bottom:12px}
    .log-tag{font-size:.8rem;font-weight:600;padding:4px 10px;border-radius:12px;color:#fff}
    .tag-error{background-color:var(--red)}.tag-warning{background-color:var(--orange)}
    .log-message{flex-grow:1}.log-timestamp{font-size:.85rem;color:var(--text-muted);align-self:flex-start}
    .backup-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:24px;text-align:center}
    .backup-card .btn{width:100%;margin-top:16px;padding:12px;font-size:1rem}
    .login-modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:grid;place-items:center}
    .login-card{background:#fff;border-radius:12px;padding:24px;width:min(420px,calc(100% - 32px));box-shadow:0 8px 24px rgba(0,0,0,.2)}
    .login-card h2{margin-bottom:8px}
    .login-card p{color:var(--text-muted);margin-bottom:16px}
    .login-card input{width:100%;padding:12px 14px;border-radius:8px;border:1px solid #bdc3c7;font-family:'Poppins',sans-serif;margin-bottom:12px}
    .login-actions{display:flex;gap:12px;justify-content:flex-end}
    .hidden{display:none}
  </style>
</head>
<body>
  <div id="login" class="login-modal hidden">
    <div class="login-card">
      <h2>Entrar como Admin</h2>
      <p>Use suas credenciais de administrador.</p>
      <input id="email" type="email" placeholder="E-mail" />
      <input id="password" type="password" placeholder="Senha" />
      <div style="display:flex;align-items:center;justify-content:space-between;margin-top:6px;margin-bottom:6px">
        <small id="loginError" style="color:#e74c3c;visibility:hidden">&nbsp;</small>
        <div class="login-actions">
          <button id="loginBtn" class="btn-purple">Entrar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="admin-panel">
    <header class="main-header">
      <div class="header-title">
        <div class="logo"><i class="fas fa-shield-alt"></i></div>
        <div class="title-text">
          <h1>Dashboard Admin</h1>
          <p>Marido de Aluguel Carioca</p>
        </div>
      </div>
      <div>
        <span class="status-badge" id="statusBadge">Offline</span>
      </div>
    </header>

    <nav class="main-nav">
      <ul>
        <li><a href="#" class="nav-link active" data-target="visao-geral"><i class="fas fa-chart-pie"></i> Visão Geral</a></li>
        <li><a href="#" class="nav-link" data-target="notificacoes"><i class="fas fa-bell"></i> Notificações</a></li>
        <li><a href="#" class="nav-link" data-target="usuarios"><i class="fas fa-users"></i> Usuários</a></li>
        <li><a href="#" class="nav-link" data-target="gerenciar"><i class="fas fa-cogs"></i> Gerenciar</a></li>
        <li><a href="#" class="nav-link" data-target="erros"><i class="fas fa-exclamation-triangle"></i> Erros</a></li>
        <li><a href="#" class="nav-link" data-target="backup"><i class="fas fa-hdd"></i> Backup</a></li>
      </ul>
    </nav>

    <main class="content-area">
      <div id="visao-geral" class="page active">
        <div class="overview-grid">
          <div class="card stat-card"><div class="title">Total de Clientes</div><div class="value" id="statClients">0</div><div class="detail" id="statClientsDetail">&nbsp;</div><i class="fas fa-users icon"></i></div>
          <div class="card stat-card"><div class="title">Total de Prestadores</div><div class="value" id="statProviders">0</div><div class="detail" id="statProvidersDetail" style="color:#e67e22">&nbsp;</div><i class="fas fa-user-check icon"></i></div>
          <div class="card stat-card"><div class="title">Serviços Ativos</div><div class="value" id="statActive">0</div><div class="detail" id="statActiveDetail">&nbsp;</div><i class="fas fa-cog icon"></i></div>
          <div class="card stat-card"><div class="title">Erros Recentes</div><div class="value" id="statErrors">0</div><div class="detail" style="color:var(--red);">&nbsp;</div><i class="fas fa-exclamation-triangle icon"></i></div>
        </div>
      </div>

      <div id="notificacoes" class="page">
        <div class="card form-section">
          <h2 class="title">Enviar Notificação</h2>
          <p class="subtitle">Envie avisos para clientes e prestadores de serviço.</p>
          <form>
            <div class="form-group"><label>Destinatários</label><select id="notifyTarget"><option value="all">Todos os usuários</option><option value="client">Apenas Clientes</option><option value="provider">Apenas Prestadores</option></select></div>
            <div class="form-group"><label>Mensagem da Notificação</label><textarea id="notifyMsg" placeholder="Digite sua mensagem aqui..."></textarea></div>
            <button type="button" id="notifyBtn" class="btn-purple"><i class="fas fa-paper-plane"></i> Enviar Notificação</button>
          </form>
        </div>
      </div>

      <div id="usuarios" class="page">
        <div class="user-stats-grid">
          <div class="card"><h2 class="title">Estatísticas de Clientes</h2><div class="stat-list"><div class="item"><span>Total de Cadastros</span><span class="stat-value" id="clientsCount">0</span></div><div class="item"><span>Ativos este mês</span><span class="stat-value">-</span></div><div class="item"><span>Novos hoje</span><span class="stat-value">-</span></div></div></div>
          <div class="card"><h2 class="title">Estatísticas de Prestadores</h2><div class="stat-list"><div class="item"><span>Total de Cadastros</span><span class="stat-value" id="providersCount">0</span></div><div class="item"><span>Ativos este mês</span><span class="stat-value">-</span></div><div class="item"><span>Novos hoje</span><span class="stat-value">-</span></div></div></div>
        </div>
      </div>

      <div id="gerenciar" class="page">
        <div class="card">
          <div class="manage-header"><h2 class="title">Gerenciar Perfis</h2><button class="btn-purple" id="createUserBtn" style="padding:10px 20px"><i class="fas fa-plus"></i> Cadastrar Usuário</button></div>
          <p class="subtitle">Filtre e gerencie perfis de clientes e prestadores.</p>
          <div class="search-filter" style="margin-bottom: 24px;"><input id="searchInput" type="text" placeholder="Filtrar por email, nome ou telefone..."></div>
          <h3 style="margin-bottom:16px;">Usuários (<span id="usersCount">0</span>)</h3>
          <div class="user-list" id="userList"></div>
        </div>
      </div>

      <div id="erros" class="page">
        <div class="card">
          <h2 class="title">Log de Erros do Backend</h2>
          <p class="subtitle">Monitore erros e problemas do sistema para suporte.</p>
          <div class="user-list" style="max-height:450px;" id="logs"></div>
        </div>
      </div>

      <div id="backup" class="page">
        <div class="backup-grid">
          <div class="card backup-card"><h2 class="title">Backup Completo</h2><p class="subtitle">Backup de todos os dados do sistema.</p><button class="btn" id="backupAll" style="background:var(--blue)"><i class="fas fa-download"></i> Backup Completo</button></div>
          <div class="card backup-card"><h2 class="title">Backup Clientes</h2><p class="subtitle">Backup apenas dos dados de clientes.</p><button class="btn" id="backupClients" style="background:var(--green)"><i class="fas fa-download"></i> Backup Clientes</button></div>
          <div class="card backup-card"><h2 class="title">Backup Prestadores</h2><p class="subtitle">Backup apenas dos dados de prestadores.</p><button class="btn" id="backupProviders" style="background:var(--orange)"><i class="fas fa-download"></i> Backup Prestadores</button></div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Config dinâmica de API: prioriza localStorage('mdac_api_base'), depois /admin/api-base.json, senão relative /api
    let API_BASE = localStorage.getItem('mdac_api_base') || (window.ADMIN_API_BASE) || (document.querySelector('meta[name=api-base]')?.content) || (location.origin.replace(/\/$/, '') + '/api');
    const TOKEN_KEY = 'mdac_token';
    const getToken = () => localStorage.getItem(TOKEN_KEY);
    const setToken = (t) => localStorage.setItem(TOKEN_KEY, t);
    const clearToken = () => localStorage.removeItem(TOKEN_KEY);

    const authFetch = async (url, init={}) => {
      const headers = Object.assign({}, init.headers||{}, { 'Content-Type': 'application/json' });
      const token = getToken();
      if (token) headers['Authorization'] = 'Bearer ' + token;
      const res = await fetch(url, { ...init, headers });
      if (res.status === 401) { clearToken(); showLogin(); }
      return res;
    };

    // UI helpers
    const qs = (s, el=document) => el.querySelector(s);
    const qsa = (s, el=document) => Array.from(el.querySelectorAll(s));
    const statusBadge = qs('#statusBadge');

    // Nav
    document.addEventListener('DOMContentLoaded', async () => {
      // Tenta carregar config externa se não houver override em localStorage
      if (!localStorage.getItem('mdac_api_base')) {
        try {
          const cfgRes = await fetch('./api-base.json', { cache: 'no-store' });
          if (cfgRes.ok) {
            const { base } = await cfgRes.json();
            if (base) { API_BASE = base.replace(/\/$/, ''); }
          }
        } catch (e) { /* ignore */ }
      }
      qsa('.nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          qsa('.nav-link').forEach(n => n.classList.remove('active'));
          link.classList.add('active');
          const target = link.getAttribute('data-target');
          qsa('.page').forEach(p => p.classList.toggle('active', p.id === target));
        });
      });
      qs('#loginBtn').addEventListener('click', doLogin);
      qs('#notifyBtn').addEventListener('click', sendNotification);
      qs('#searchInput').addEventListener('input', filterUsers);
      qs('#backupAll').addEventListener('click', () => downloadCsv('all'));
      qs('#backupClients').addEventListener('click', () => downloadCsv('client'));
      qs('#backupProviders').addEventListener('click', () => downloadCsv('provider'));
  boot();
    });

    function showLogin() {
      qs('#login').classList.remove('hidden');
      statusBadge.textContent = 'Offline';
      statusBadge.style.background = '#e74c3c';
    }
    function hideLogin() {
      qs('#login').classList.add('hidden');
      statusBadge.textContent = 'Online';
      statusBadge.style.background = 'var(--green)';
    }

    async function boot() {
      if (!getToken()) { showLogin(); return; }
      hideLogin();
      await refreshData();
    }

  async function doLogin() {
      const email = qs('#email').value.trim();
      const password = qs('#password').value;
      const errEl = qs('#loginError');
      errEl.style.visibility = 'hidden';
      try {
    const res = await fetch(API_BASE + '/auth/login', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ email, password }) });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.message || 'Falha no login');
        if (!data?.token) throw new Error('Token ausente');
        // Pequena verificação do payload
        try { const payload = JSON.parse(atob(data.token.split('.')[1])); if (payload.role !== 'admin') throw new Error('Acesso restrito a admin'); } catch {}
        setToken(data.token);
        hideLogin();
        await refreshData();
      } catch (e) {
        errEl.textContent = e.message || 'Erro ao entrar';
        errEl.style.visibility = 'visible';
      }
    }

    async function refreshData() {
      await Promise.all([loadStats(), loadUsers()]);
    }

    // Admin APIs
    async function loadStats() {
      try {
        const res = await authFetch(API_BASE + '/admin/stats');
        if (!res.ok) throw new Error('Falha ao obter estatísticas');
        const data = await res.json();
        const clients = data?.users?.client || 0;
        const providers = data?.users?.provider || 0;
        const totalActive = (data?.requests?.['Pendente'] || 0) + (data?.requests?.['Orçamento Enviado'] || 0) + (data?.requests?.['Aceito'] || 0);
        qs('#statClients').textContent = clients;
        qs('#statProviders').textContent = providers;
        qs('#clientsCount').textContent = clients;
        qs('#providersCount').textContent = providers;
        qs('#statActive').textContent = totalActive;
      } catch (e) { console.warn(e); }
    }

    async function loadUsers() {
      try {
        const res = await authFetch(API_BASE + '/admin/users');
        if (!res.ok) throw new Error('Falha ao listar usuários');
        const users = await res.json();
        renderUsers(users);
      } catch (e) { console.warn(e); }
    }

    function renderUsers(users) {
      const list = qs('#userList');
      list.innerHTML = '';
      const q = qs('#searchInput').value.trim().toLowerCase();
      const filtered = users.filter(u => !q || (u.email?.toLowerCase().includes(q) || u.name?.toLowerCase().includes(q) || u.phone?.toLowerCase().includes(q)));
      qs('#usersCount').textContent = filtered.length;
      for (const u of filtered) {
        const tagClass = u.role === 'client' ? 'tag-cliente' : (u.role === 'provider' ? 'tag-prestador' : 'tag-admin');
        const item = document.createElement('div');
        item.className = 'user-item';
        item.innerHTML = `<span class="user-tag ${tagClass}">${u.role === 'client' ? 'Cliente' : (u.role === 'provider' ? 'Prestador' : 'Admin')}</span>
          <div class="user-info"><div class="name">${u.name || '-'} </div><div class="contact">${u.email} • ${u.phone || '-'}</div></div>
          <div class="user-actions">
            <button class="btn" style="background:var(--blue)" title="Ver"><i class="fas fa-eye"></i></button>
            <button class="btn" style="background:var(--green)" title="Editar"><i class="fas fa-pen"></i></button>
            <button class="btn" style="background:var(--red)" title="Excluir" data-del="${u.email}"><i class="fas fa-trash"></i></button>
          </div>`;
        list.appendChild(item);
      }
      // Bind delete
      qsa('[data-del]', list).forEach(btn => btn.addEventListener('click', async () => {
        const email = btn.getAttribute('data-del');
        if (!confirm('Excluir ' + email + '?')) return;
        try {
          const res = await authFetch(API_BASE + '/admin/users/' + encodeURIComponent(email), { method: 'DELETE' });
          if (!res.ok) throw new Error('Falha ao excluir');
          await loadUsers();
        } catch (e) { alert(e.message || 'Erro'); }
      }));
    }

    function filterUsers() { loadUsers(); }

    async function sendNotification() {
      const target = qs('#notifyTarget').value;
      const msg = qs('#notifyMsg').value.trim();
      if (!msg) { alert('Digite uma mensagem.'); return; }
      try {
        // Reuso do endpoint push/send-test para prova de conceito;
        // num futuro, criar endpoint dedicado.
        const res = await authFetch(API_BASE + '/push/send-test', {
          method: 'POST',
          body: JSON.stringify({ title: 'Admin', body: msg, target })
        });
        if (!res.ok) throw new Error('Falha ao enviar');
        alert('Notificação enviada (teste).');
      } catch (e) { alert(e.message || 'Erro'); }
    }

  function downloadCsv(kind) {
      // Gera CSV a partir da lista renderizada
      const rows = [['role','name','email','phone']];
      qsa('.user-item').forEach(it => {
        const role = it.querySelector('.user-tag').textContent.trim();
        const name = it.querySelector('.name').textContent.trim();
        const contact = it.querySelector('.contact').textContent.trim();
        const [email, phone] = contact.split(' • ');
        if (kind === 'client' && role !== 'Cliente') return;
        if (kind === 'provider' && role !== 'Prestador') return;
        rows.push([role,name,email,phone]);
      });
      const csv = rows.map(r => r.map(v => '"' + String(v).replace(/"/g,'""') + '"').join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'backup-' + kind + '.csv';
      a.click();
    }
  </script>
</body>
</html>
